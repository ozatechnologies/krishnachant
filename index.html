<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Krishna Chanting App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #f4f6f9; }
        .chant-container { max-width: 600px; margin: auto; }
        .chant-card { 
            transition: transform 0.3s; 
            cursor: pointer; 
        }
        .chant-card:hover { transform: scale(1.05); }
    </style>
</head>
<body>
    <div class="container chant-container mt-5">
        <div id="auth-container" class="card p-4">
            <h2 class="text-center mb-4">Krishna Chanting Portal</h2>
            <div class="mb-3">
                <input type="email" id="email" class="form-control" placeholder="Email">
            </div>
            <div class="mb-3">
                <input type="password" id="password" class="form-control" placeholder="Password">
            </div>
            <div class="d-flex justify-content-between">
                <button id="loginBtn" class="btn btn-primary">Login</button>
                <button id="registerBtn" class="btn btn-success">Register</button>
            </div>
            <div id="error-message" class="text-danger mt-3"></div>
        </div>

        <div id="chanting-section" style="display:none;">
            <div class="card mt-4">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">Shree Krishna Sharnamaha Chanting</h3>
                    <button id="logoutBtn" class="btn btn-light float-end">Logout</button>
                </div>
                <div class="card-body">
                    <div id="chant-stats" class="mb-3">
                        <h4>Your Chanting Stats</h4>
                        <p>Total Chants: <span id="total-chants">0</span></p>
                        <p>Current Level: <span id="current-level">Beginner</span></p>
                    </div>

                    <div class="chant-bank">
                        <h4>Chant Bank</h4>
                        <div id="chant-list" class="row"></div>
                    </div>

                    <div class="mt-4">
                        <button id="customChantBtn" class="btn btn-success me-2">Add Custom Chant</button>
                        <button id="mahaMantraBtn" class="btn btn-warning">Maha Mantra Challenge</button>
                    </div>
                </div>
            </div>

            <div class="card mt-4">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">Global Leaderboard</h3>
                </div>
                <div class="card-body">
                    <ol id="global-leaderboard" class="list-group list-group-numbered"></ol>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <script>
        // Firebase Configuration
        var firebaseConfig = {
            apiKey: "AIzaSyC3mwFH49WiG4Swjmo-1JV9wjAMBIDkLA4",
            authDomain: "pushtiwords.firebaseapp.com",
            projectId: "pushtiwords",
            databaseURL: "https://pushtiwords-default-rtdb.firebaseio.com",
            storageBucket: "pushtiwords.appspot.com",
            messagingSenderId: "460696747514",
            appId: "1:460696747514:web:40e94e966bdfcfe624b843"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        var auth = firebase.auth();
        var database = firebase.database();

        // Global variables
        var currentUser = null;
        var PREDEFINED_CHANTS = [
            "Hare Krishna Hare Krishna, Krishna Krishna Hare Hare",
            "Hare Rama Hare Rama, Rama Rama Hare Hare",
            "Shree Krishna Sharnamaha",
            "Radhe Radhe"
        ];

        // Utility Functions
        function showError(message) {
            document.getElementById('error-message').textContent = message;
        }

        function clearError() {
            document.getElementById('error-message').textContent = '';
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Login
            document.getElementById('loginBtn').addEventListener('click', function() {
                clearError();
                var email = document.getElementById('email').value.trim();
                var password = document.getElementById('password').value.trim();

                if (!email || !password) {
                    showError('Please enter both email and password');
                    return;
                }

                auth.signInWithEmailAndPassword(email, password)
                    .then(function(userCredential) {
                        currentUser = userCredential.user;
                        showChantingSection(currentUser);
                    })
                    .catch(function(error) {
                        showError(error.message);
                    });
            });

            // Register
            document.getElementById('registerBtn').addEventListener('click', function() {
                clearError();
                var email = document.getElementById('email').value.trim();
                var password = document.getElementById('password').value.trim();

                if (!email || !password) {
                    showError('Please enter both email and password');
                    return;
                }

                auth.createUserWithEmailAndPassword(email, password)
                    .then(function(userCredential) {
                        currentUser = userCredential.user;
                        
                        // Create user profile in database
                        return database.ref('users/' + currentUser.uid).set({
                            email: currentUser.email,
                            totalChants: 0,
                            level: "Beginner",
                            createdAt: firebase.database.ServerValue.TIMESTAMP
                        });
                    })
                    .then(function() {
                        showChantingSection(currentUser);
                    })
                    .catch(function(error) {
                        showError(error.message);
                    });
            });

            // Logout
            document.getElementById('logoutBtn').addEventListener('click', function() {
                auth.signOut().then(function() {
                    currentUser = null;
                    document.getElementById('auth-container').style.display = 'block';
                    document.getElementById('chanting-section').style.display = 'none';
                }).catch(function(error) {
                    showError(error.message);
                });
            });

            // Custom Chant
            document.getElementById('customChantBtn').addEventListener('click', function() {
                var customChant = prompt("Enter your custom chant:");
                if (customChant && customChant.trim()) {
                    PREDEFINED_CHANTS.push(customChant.trim());
                    loadChants();
                }
            });

            // Maha Mantra Challenge
            document.getElementById('mahaMantraBtn').addEventListener('click', function() {
                alert("Maha Mantra Challenge: Chant 1008 times for spiritual elevation!");
            });

            // Authentication state listener
            auth.onAuthStateChanged(function(user) {
                if (user) {
                    currentUser = user;
                    showChantingSection(user);
                } else {
                    currentUser = null;
                    document.getElementById('auth-container').style.display = 'block';
                    document.getElementById('chanting-section').style.display = 'none';
                }
            });
        });

        // Existing functions remain the same
        function showChantingSection(user) {
            if (!user) return;

            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('chanting-section').style.display = 'block';

            var userProfileRef = database.ref('users/' + user.uid);
            userProfileRef.once('value').then(function(snapshot) {
                var userData = snapshot.val();
                if (userData) {
                    document.getElementById('total-chants').textContent = userData.totalChants || 0;
                    document.getElementById('current-level').textContent = userData.level || "Beginner";
                }
            });

            loadChants();
            updateLeaderboard();
        }

        function loadChants() {
            var chantList = document.getElementById('chant-list');
            chantList.innerHTML = PREDEFINED_CHANTS.map(function(chant) {
                return `
                    <div class="col-md-6 mb-3">
                        <div class="card chant-card" onclick="performChant('${chant}')">
                            <div class="card-body">
                                <h5 class="card-title">${chant}</h5>
                                <button class="btn btn-primary btn-sm">Chant</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function performChant(chantName) {
            if (!currentUser) return;

            var userChantsRef = database.ref('chants/' + currentUser.uid + '/' + chantName);
            var userProfileRef = database.ref('users/' + currentUser.uid);

            userChantsRef.transaction(function(currentCount) {
                return (currentCount || 0) + 1;
            });

            userProfileRef.transaction(function(profile) {
                var newTotalChants = (profile.totalChants || 0) + 1;
                var newLevel = calculateLevel(newTotalChants);
                
                return {
                    ...profile,
                    totalChants: newTotalChants,
                    level: newLevel
                };
            }).then(function() {
                var totalChantsElement = document.getElementById('total-chants');
                totalChantsElement.textContent = parseInt(totalChantsElement.textContent) + 1;
                
                var audio = new Audio('https://sndup.net/r3ncc/');
                audio.play();

                updateLeaderboard();
            });
        }

        function calculateLevel(totalChants) {
            if (totalChants < 100) return "Beginner";
            if (totalChants < 500) return "Novice";
            if (totalChants < 1000) return "Intermediate";
            if (totalChants < 5000) return "Advanced";
            return "Spiritual Master";
        }

        function updateLeaderboard() {
            var leaderboardRef = database.ref('users').orderByChild('totalChants').limitToLast(10);
            var leaderboardElement = document.getElementById('global-leaderboard');

            leaderboardRef.once('value', function(snapshot) {
                var users = [];
                snapshot.forEach(function(childSnapshot) {
                    users.push({
                        email: childSnapshot.val().email,
                        totalChants: childSnapshot.val().totalChants || 0
                    });
                });

                users.sort(function(a, b) { return b.totalChants - a.totalChants; });

                leaderboardElement.innerHTML = users.map(function(user) {
                    return `
                        <li class="list-group-item d-flex justify-content-between align-items-start">
                            <div class="ms-2 me-auto">
                                <div class="fw-bold">${user.email.split('@')[0]}</div>
                            </div>
                            <span class="badge bg-primary rounded-pill">${user.totalChants}</span>
                        </li>
                    `;
                }).join('');
            });
        }
    </script>
</body>
</html>
